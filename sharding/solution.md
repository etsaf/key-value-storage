Ноды хэшируются методом sha256 и распределяются по кругу остатков по модулю 1048576. Каждая отвечает за свою часть круга. Ключи тоже хэшируются и соответствующее значение хранится на ближайшей по часовой стрелке ноде. При добавлении новой ноды следующая за ней отправляет ей часть значений. При удалении ноды ключи, хранившиеся на ней, поступают на следующую.

Для равномерности распределения для каждой ноды хранится 500 виртуальных нод с хэшами, полученными из i + node_id, где i от 1 до 500.

Поиск следующей ноды: по списку нод восстанавливается отсортированный список всех хэшей нод, в нем методом bisect.bisect_left ищется нужный хэш, который потом сопоставляется id ноды в словаре, тоже восстановленном по списку, хранящемуся на ноде.

Локальные сообщения:

GET, PUT, DELETE - определяет, на какой ноде хранится ключ, и отправляет туда одноименный запрос, если это другая нода, или выполняет требуемое действие и возвращает ответ, если исходная нода

NODE_ADDED - добавляет ноду и ее хэш в словари и списки, определяет, кто следующие за виртуальными нодами добавленной. Если это исходная нода, выбирает из self._data ключи, которые надо отдать новой ноде и передает их все сообщением NODE_ADDED

NODE_REMOVED - сверяет id удаляемой ноды со своим. Если совпадает, отправляет части self._data на следующие виртуальные ноды сообщением NODE_ADDED

Сетевые сообщения:

GET, DELETE - выполняет требуемое действие и отправляет ответ на ноду-отправителя

PUT - проверяет по хэшу ключа, нужно ли его положить в self._data. Если да, сохраняет значение у себя и отправляет ответ исходному отправителю сообщения. Если нет, пересылает сообщение на ту ноду, куда нужно положить

GET_RESP, PUT_RESP, DELETE_RESP - возвращает ответ на local

NODE_ADDED - для всех ключей в полученном сообщении сверяет хэш, если нужно - сохранят у себя, если нет - пересылает куда нужно
